# 静默协作 v1.0.2 - 智能连接切换功能

## 更新内容

### 🚀 新增功能
- **智能服务器连接策略**: 应用启动时自动测试并选择最佳可用服务器
- **自动故障转移**: 当远程服务器(47.95.200.35:8081)无法连接时，自动切换到本地服务器
- **动态服务器切换**: 在请求过程中检测到连接问题时自动尝试其他服务器

### 🔧 技术改进
- **异步初始化**: ApiService改为异步初始化，确保连接测试完成后再启动应用
- **连接测试优化**: 改进连接测试逻辑，支持多种测试路径
- **CORS头部清理**: 移除无效的客户端CORS头部设置

### 📋 服务器优先级列表
应用将按以下优先级尝试连接：
1. `http://47.95.200.35:8081` - 生产环境服务器
2. `http://127.0.0.1:8081` - 本地回环地址
3. `http://localhost:8081` - localhost
4. `http://10.0.2.2:8081` - Android 模拟器访问宿主机
5. `http://192.168.1.100:8081` - 局域网地址

## 工作原理

### 应用启动时
1. **初始化检测**: main()函数中调用`ApiService.initialize()`
2. **连接测试**: 依次测试所有可能的服务器地址
3. **最佳选择**: 选择第一个响应成功的服务器作为当前服务器
4. **Dio配置**: 使用选定的服务器URL配置网络请求客户端

### 运行时切换
1. **请求失败检测**: 当网络请求失败时触发重连逻辑
2. **自动重试**: 在原生环境下，POST请求失败时自动调用`testConnection()`
3. **动态切换**: 找到可用服务器后自动重新配置Dio实例

### Web环境支持
- **CORS处理**: Web环境使用特殊的CORS处理逻辑
- **预检请求**: 自动发送OPTIONS预检请求
- **兼容性**: 确保Web和原生环境都能正常切换服务器

## 用户体验改进

### 🔄 无感切换
- 用户无需手动配置服务器地址
- 网络问题时自动切换，用户无感知
- 启动速度优化，仅在必要时进行连接测试

### 📱 多平台支持
- **Android**: 支持真机和模拟器环境
- **Web**: 支持浏览器环境的CORS处理
- **桌面**: 支持Windows等桌面平台

### 🛡️ 健壮性增强
- **故障恢复**: 服务器故障时自动切换到可用服务器
- **连接超时**: 合理的超时设置避免长时间等待
- **错误处理**: 详细的错误日志便于问题诊断

## 技术细节

### 核心代码结构
```dart
// ApiService.initialize() - 异步初始化
static Future<void> initialize() async {
  print('ApiService 初始化中，正在测试服务器连接...');
  final connectionSuccess = await testConnection();
  
  if (!connectionSuccess) {
    print('警告: 无法连接到任何服务器，使用默认配置');
    _currentBaseUrl = _possibleBaseUrls.first;
  }
  
  _initializeDio();
}
```

### 连接测试逻辑
```dart
static Future<bool> testConnection() async {
  // 依次尝试所有可能的基础URL
  for (int i = 0; i < _possibleBaseUrls.length; i++) {
    final testUrl = _possibleBaseUrls[i];
    // 测试连接并在成功时更新当前URL
    // 支持多种测试路径：'/', '/team/get/999999', '/ping', '/health'
  }
}
```

## 版本信息
- **版本号**: v1.0.2+3
- **发布日期**: 2024年12月
- **构建信息**: 
  - Web版本: `build/web`
  - APK版本: `build/app/outputs/flutter-apk/app-release.apk`

## 使用说明

### 开发环境
1. 确保本地服务器运行在8081端口
2. 应用会自动检测并使用本地服务器
3. 查看控制台日志了解连接状态

### 生产环境
1. 应用优先使用远程服务器
2. 远程服务器不可用时自动降级到本地服务器
3. 无需用户干预，自动处理网络切换

## 故障排查

### 常见问题
1. **所有服务器都无法连接**: 检查网络连接和防火墙设置
2. **Web版本CORS错误**: 确保服务器端正确配置CORS头部
3. **Android模拟器连接问题**: 确保10.0.2.2地址可达

### 调试信息
- 查看控制台输出的连接测试日志
- 关注"ApiService 初始化中"等关键日志
- 观察"切换到新的基础URL"等切换日志

## 未来规划
- [ ] 添加服务器健康检查
- [ ] 实现连接质量评估
- [ ] 支持用户自定义服务器列表
- [ ] 添加网络状态监控
